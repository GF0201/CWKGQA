# Task #4 证据链汇报：可审计可复核

## (1) 统计/显著性模块：pytest 证据

**命令**：在 NEW_DIR 根目录运行 `pytest -q`

**输出保存位置**：`runs/evidence_task4/artifacts/pytest.txt`

**前 20 行片段**：

```
1|============================= test session starts ==============================
2|platform win32 -- Python 3.13.9, pytest-8.3.4, pluggy-1.6.0
3|rootdir: C:\Users\顾北上\KGELLM\kgqa_framework
4|collected 4 items
5|
6|tests/test_stats.py ....                                                 [100%]
7|
8|============================== 4 passed in 2.04s ===============================
```

**说明**：`core.stats` 的 `bootstrap_ci`、`paired_bootstrap_delta`、`mcnemar_test` 单元测试全部通过；同 seed 输出可复现，不同 seed 输出不同。

---

## (2) Case study：落盘结构

**命令**：
```bash
python scripts/export_case_studies.py --run-id real_dev3_task3_fix1 --topk 5
```

**生成文件**：`runs/real_dev3_task3_fix1/artifacts/case_studies.md`

**前 60 行片段**（含至少 1 个 case 条目字段）：

```markdown
1|## Case Studies
2|
3|- Run directory: `C:\Users\顾北上\KGELLM\kgqa_framework\runs\real_dev3_task3_fix1`
4|- Source file: `...\artifacts\per_sample_results.jsonl`
5|
6|### Group: status=metric_missing, error_type=metric_missing
7|
8|1. `qid=6637`
9|   - **question**: What is Peter Cosgrove's given name in the series ordinal 2?
10|   - **status**: `metric_missing`
11|   - **error_type**: `metric_missing`
12|   - **http_status**: `None`
13|   - **trace_path**: `C:\Users\顾北上\KGELLM\kgqa-thesis\outputs\runs\run_20260202_190530`
14|
15|2. `qid=11528`
16|   - **question**: What did is the post of Austen Chamberlain and vested?
17|   - **status**: `metric_missing`
18|   - **error_type**: `metric_missing`
19|   - **http_status**: `None`
20|   - **trace_path**: `C:\Users\顾北上\KGELLM\kgqa-thesis\outputs\runs\run_20260202_190530`
21|
22|3. `qid=29557`
23|   - **question**: Which is the Library of Congress Cultural Heritage Organizations...
24|   - **status**: `metric_missing`
25|   - **error_type**: `metric_missing`
26|   - **http_status**: `None`
27|   - **trace_path**: `C:\Users\顾北上\KGELLM\kgqa-thesis\outputs\runs\run_20260202_190530`
```

**说明**：`export_case_studies.py` 支持 `--run-id`，按 status/error_type 分组导出 topK，每 case 含 qid、question、status、error_type、http_status、trace_path。

---

## (3) KG 审计：summarize-only 不覆盖人工标注

**操作**：
1. 对 `runs/kg_audit_demo/artifacts/kg_sample_audit.csv` 手动填 2 行 `label_strict`/`label_relaxed`：
   - 第 2 行：`correct`, `correct`
   - 第 3 行：`incorrect`, `correct`
2. 运行汇总：
   ```bash
   python scripts/gen_kg_sample_audit.py --input data/triples_demo.tsv --n 5 --seed 42 --output-id kg_audit_demo --summarize-only
   ```

**summary.json（precision 已数值化）**：

```json
{
  "n": 5,
  "n_annotated_strict": 2,
  "n_correct_strict": 1,
  "strict_precision": 0.5,
  "n_annotated_relaxed": 2,
  "n_correct_relaxed": 2,
  "relaxed_precision": 1.0,
  "seed": 42,
  "input": "data\\triples_demo.tsv"
}
```

**CSV 未被覆盖的佐证**：
- `--summarize-only` 下脚本仅读取已有 `kg_sample_audit.csv`，不执行抽样与写 CSV。
- 抽样行（triple_id 4,2,3,5,1 及其 subject/predicate/object）保持不变；人工填写的 `correct`/`incorrect` 仍在第 2、3 行。

---

## (4) domain_main validator：bad 样本闭环

**坏样本文件**：`data/domain_main_demo_bad.jsonl`
- 第 1 行：合法样本（含 qid/question/answers）
- 第 2 行：缺 `qid`，触发 schema 校验失败

**命令**：
```bash
python scripts/run_domain_main_smoke.py --data_file data/domain_main_demo_bad.jsonl --limit 3 --seed 42 --output-id domain_main_smoke_bad1
```

### repro_manifest.json args 片段（n_bad > 0）

```json
"args": {
  "data_file": "data\\domain_main_demo_bad.jsonl",
  "limit": 3,
  "seed": 42,
  "output_id": "domain_main_smoke_bad1",
  "mode": "domain_main_smoke",
  "n_total": 2,
  "n_ok": 1,
  "n_bad": 1
}
```

### failures.csv（至少 1 行 error_type=schema_invalid）

```csv
qid,question,status,is_executable,http_status,error_type,em,f1,trace_path
,Missing qid,fail,False,,schema_invalid,,,
```

### bad_examples_path 非空

- `validate_dataset()` 落盘：`data/domain_main_demo_bad.jsonl.bad.jsonl`
- `repro_manifest.json` 的 `warnings` 含：`"schema_invalid: bad_count=1, bad_examples=data\\domain_main_demo_bad.jsonl.bad.jsonl"`

---

## 修改文件清单

| 文件 | 变更 |
|------|------|
| `scripts/export_case_studies.py` | 增加 `--run-id`，支持 `--topk` |
| `runs/evidence_task4/artifacts/pytest.txt` | 新增，pytest 输出 |
| `runs/kg_audit_demo/artifacts/kg_sample_audit.csv` | 人工填 2 行 label |
| `runs/kg_audit_demo/artifacts/kg_sample_audit_summary.json` | 更新，precision 数值化 |
| `data/domain_main_demo_bad.jsonl` | 新增，含 1 行坏样本 |
| `data/domain_main_demo_bad.jsonl.bad.jsonl` | 新增，bad 样本落盘 |
| `runs/domain_main_smoke_bad1/` | 新增，repro_manifest、run.log、artifacts |
| `本次结果汇报.md` | 新增 |
